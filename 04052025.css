<?php

class Related_Tag_Service
{
    private static array $instance = [];
    private array $mappings = [];
    private array $rows = [];
    private string $current_path = '';
    private array $data = [];
    private array $replace_map = [];
    private array $result = [];

    private function __construct()
    {
        $this->mappings = config('related-tag_map') ?? [];
        $this->rows     = read_csv('purchase_item_list') ?? [];
    }

    public static function get_instance(?string $url = null): self
    {
        if (empty(self::$instance[$url])) {
            self::$instance[$url] = new self();
        }

        return self::$instance[$url];
    }

    private function prepare_data(?string $custom_path = null): bool
    {
        $this->current_path = '';
        $this->data         = [];
        $this->replace_map  = [];
        $this->result       = [];

        $this->current_path = get_path($custom_path)
            ->without_query()
            ->without_page()
            ->without_lp()
            ->get();

        $this->data = get_item_in_csv(
            'purchase_item_list',
            $this->current_path,
            'target_url'
        ) ?? [];

        if (!empty($this->data)) {
            $this->replace_map = $this->build_replace_map($this->data);
        }

        return !empty($this->mappings)
            && !empty($this->rows)
            && !empty($this->data);
    }

    public function handle(?string $custom_path = null): array
    {
        if (!$this->prepare_data($custom_path)) {
            return [];
        }

        foreach ($this->mappings as $map) {
            if (
                !empty($map['condition'])
                && !$this->match_conditions($this->data, $map['condition'])
            ) {
                continue;
            }

            foreach ($map['result_items'] ?? [] as $item) {
                $this->result[] = [
                    'heading' => strtr(
                        trim($item['heading'] ?? '他の条件で買取実績を探す'),
                        $this->replace_map
                    ),
                    'box' => [],
                ];

                $idx = array_key_last($this->result);

                foreach ($item['boxes'] ?? [] as $i => $box) {
                    $list = $this->resolve_filter($box);
                    if (empty($list)) {
                        continue;
                    }

                    $this->result[$idx]['box'][] = [
                        'box_key'     => $box['key'] ?? $i,
                        'sub_heading' => $this->resolve_sub_heading(
                            $box['sub_heading'] ?? '',
                            $this->result[$idx]['box']
                        ),
                        'list' => $list,
                    ];
                }

                if (empty($this->result[$idx]['box'])) {
                    unset($this->result[$idx]);
                }
            }
        }

        return array_values($this->result);
    }

    private function build_replace_map(array $data): array
    {
        $map = [];
        foreach ($data as $key => $value) {
            if (is_scalar($value)) {
                $map["{{$key}}"] = $value;
            }
        }
        return $map;
    }

    private function resolve_filter(array $box): array
    {
        $filter = $box['filter'] ?? [];
        $display_fields = $box['display_text_fields'] ?? [];
        $results = [];

        foreach ($filter as $field => &$value) {
            if (is_bool($value) || !is_string($value)) {
                continue;
            }

            $value = strtr($value, $this->replace_map);

            if (str_starts_with($value, 'not_in:')) {
                $exclude = $this->collect_not_in_values(
                    substr($value, 7),
                    $field
                );
                if (!empty($exclude)) {
                    $value = ['not_in' => $exclude];
                }
            }
        }
        unset($value);

        foreach ($this->rows as $row) {
            if (!$this->match_conditions($row, $filter)) {
                continue;
            }

            if (
                $this->current_path
                && ($row['target_url'] ?? '') === $this->current_path
            ) {
                continue;
            }

            $display_text = '';
            foreach ($display_fields as $f) {
                if (!empty($row[$f])) {
                    $display_text = $row[$f];
                    break;
                }
            }

            $row['display_text'] = $display_text
                ?: ($row['text_for_page_list'] ?? '');

            $results[] = $row;
        }

        return $results;
    }

    private function collect_not_in_values(string $ref_key, string $field): array
    {
        foreach ($this->result as $group) {
            foreach ($group['box'] ?? [] as $box) {
                if (($box['box_key'] ?? null) !== $ref_key) {
                    continue;
                }
                return array_values(array_unique(array_filter(
                    array_column($box['list'], $field)
                )));
            }
        }
        return [];
    }

    private function resolve_sub_heading(string|array $sub, array $boxes): string
    {
        if (is_array($sub)) {
            $sub = empty($boxes)
                ? ($sub['default'] ?? '')
                : ($sub['is_first'] ?? '');
        }
        return strtr((string)$sub, $this->replace_map);
    }

    private function match_conditions(array $row, array $conditions): bool
    {
        foreach ($conditions as $key => $expected) {
            if (is_array($expected) && isset($expected['not_in'])) {
                if (
                    ($row[$key] ?? null) !== null
                    && in_array($row[$key], $expected['not_in'], true)
                ) {
                    return false;
                }
                continue;
            }

            if (!array_key_exists($key, $row)) {
                return false;
            }

            $value = $row[$key];

            if (is_bool($expected)) {
                $truthy = !empty(trim((string)$value))
                    && !in_array(strtolower(trim((string)$value)), ['false', '0'], true);
                if ($expected !== $truthy) {
                    return false;
                }
                continue;
            }

            if ((string)$value !== (string)$expected) {
                return false;
            }
        }

        return true;
    }
}

function get_related_tag(?string $custom_path = null): array
{
    return Related_Tag_Service::get_instance($custom_path)
        ->handle($custom_path);
}
