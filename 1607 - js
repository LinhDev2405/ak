document.addEventListener("DOMContentLoaded", () => {
	const form = document.getElementById("contact__form");

	form.addEventListener("submit", function (event) {
		event.preventDefault();
		const inputs = form.querySelectorAll("[data-rules]");
		let isValid = true;

		inputs.forEach((input) => {
			const rules = input.getAttribute("data-rules").split("|");
			const errorElement = input.nextElementSibling;
			const errorMessage = validateInput(input, rules);

			errorElement.innerText = errorMessage || "";

			if (errorMessage) {
				isValid = false;
			}

			input.addEventListener("input", () => {
				const newErrorMessage = validateInput(input, rules);
				errorElement.innerText = newErrorMessage || "";
			});
		});

		if (isValid) {
			form.submit();
		}
	});

	function validateInput(input, rules) {
		const value = input.value.trim();

		for (let rule of rules) {
			if (rule === "required" && value === "") {
				return "この項目は必須です。";
			}

			if (rule === "email" && !validateEmail(value)) {
				return "無効な電子メール";
			}

			if (rule.startsWith("max:") && !validatePhoneNumberLength(value, parseInt(rule.split(":")[1]))) {
				return `電話番号は ${rule.split(":")[1]} 桁である必要があります`;
			}

			if (rule === "number" && !validatePhoneNumber(value)) {
				return "数字を入力してください";
			}
		}

		return null;
	}

	function validateEmail(email) {
		const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
		return re.test(String(email).toLowerCase());
	}

	function validatePhoneNumber(phoneNumber) {
		const re = /^(\d{2}-\d{4}-\d{4}|\d{3}-\d{4}-\d{4})$/;
		return re.test(phoneNumber);
	}

	function validatePhoneNumberLength(phoneNumber, maxLength) {
		const stripped = phoneNumber.replace(/-/g, "");
		return stripped.length <= maxLength;
	}
});
